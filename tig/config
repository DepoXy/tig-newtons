# Author: Landon Bouma <https://tallybark.com/>
# Project: https://github.com/depoxy/tig-newtons#üçé
# License: MIT. Please find more in the LICENSE file.

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

# CXREF/2023-01-15: Tig default configuration:
#   https://jonas.github.io/tig/doc/tigrc.5.html
#   https://github.com/jonas/tig/blob/master/tigrc
#   - If you're using DepoXy, locally at:
#       ~/.kit/git/tig/tigrc
#     https://github.com/depoxy/depoxy#üçØ
#   - See also:
#       man tig
#       man tigrc
#       man tigmanual

# HINT/2020-12-14: Test/Run `tig` without loading this config:
#
#   XDG_CONFIG_HOME=not-a-path tig

# BWARE/2021-01-28: If a comment ends with a trailing slash \
# then next line or command will be ignored, commented or not.

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

# Order commits topologically
set commit-order = topo

# Do not read Git's color settings
#  set git-colors = no

# Scroll XX% of the view width
#  set horizontal-scroll = 33%
set horizontal-scroll = 25%

# Blame lines from other files
set blame-options = -C -C -C

# Wrap branch names with () and tags with <>
# Default:
#  [feature-branch] {remote/feature-branch} commit message
# Via reference-format:
#  (feature-branch) [remote/feature-branch] commit message
set reference-format = (branch) <tag> [remote]

# Configure blame view columns using command spanning multiple lines
set blame-view = \
      date:default \
      author:abbreviated \
      file-name:auto \
      id:yes,color \
      line-number:yes,interval=5 text

# Choose character graphics for revision history/ancestry lines
#  ascii|default|utf-8|<bool>
# E.g., to disable graphics characters:
#  set line-graphics = no
# The UTF-8 graphics seems most pleasing to the eye.
set line-graphics = utf-8

# Number of spaces per tab
#  tab-size = 8

# Whether to show staged and unstaged changes in the main view.
#  set show-changes = no
#  set show-changes = true

set ignore-case = smart-case

# 2020-10-21: Repair tig blame to work with git-smart .gitconfig.
# - The git-smart .gitconfig suppresses the 'a/' and 'b/' path prefixes
#   to make it easy to double-click and copy paths from terminal session.
#     https://github.com/landonb/git-smart#üí°
# - But tig blame looks upwards from the cursor for the a/ and b/ paths
#   to get the blame paths.
# - I.e., with the cursor in a diff hunk, press 'b', and tig looks
#   backward lines for the a/ and b/ files with which to run blame.
#   - What a nifty feature! But git-smart inadvertently breaks it.
#     Here we restore it.
# 2023-01-16: Note this breaks tig's built-in 'e' and :edit commands,
# which do not expect the a/ or b/ prefix. We fix (replace) the 'e'
# command below; but this setting leaves the :edit command broken.
# (But if you're like me, you almost always open in 'v' gVim.)
set diff-options = --src-prefix=a/ --dst-prefix=b/

# Some of the tig-newton commands shell-out and rebase,
# so ensure tig updates the view after any command runs.
# - Values: manual|auto|after-command|periodic|<bool>
set refresh-mode = after-command

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

# *** COLORS

# Search 'UI colors' in `man tigrc`.

# COLOR COMMAND / color area fgcolor bgcolor [attributes]

# fgcolor/bgcolor: white, black, green, magenta, blue, cyan, yellow, red, default.
#                  (default handy if your terminal is transparent, hah41, so c00l.)
# attributes: normal, blink, bold, dim, reverse, standout, and underline.
# area: interEST: can be custom quoted string for matching lines.

# General colors
#
#       default         Override default terminal colors (see above).
#
#       cursor          The cursor line.
#
#       status          The status window showing info messages.
#
#       title-focus     The title window for the current view.
#
#       title-blur      The title window of any backgrounded view.
#
#       search-result   Highlighted search result.
#
#       delimiter       Delimiter shown for truncated lines.
#
#       header          The view header lines. Use status.header to
#                       color the staged, unstaged, and untracked
#                       sections in the status view. Use help.header
#                       to color the keymap sections in the help
#                       view.
#
#       line-number     Line numbers.
#
#       id              The commit ID.
#
#       date            The author date.
#
#
#
#       author          The commit author.
#
#       mode            The file mode holding the permissions and
#                       type.
#
#       overflow        Title text overflow.
#
#       directory       The directory name.
#
#       file            The file name.
#
#       file-size       File size.

# 2020-10-21: Much better! I couldn't read through the default cursor I saw.
color cursor yellow red bold

# 2020-10-21: Now I see that I can't read the status line, either.
#             No, it's the title-focus line, the *one above* status.
color title-focus black white
# Oh, title-blus is when you have a split pane, its title.
color title-blur black white

# MAYBE: Test 'em all:
#  color default yellow green
#  color status black white
#  color title-focus black white
#  color title-blur black white
#  color search-result black white
#  color delimiter black white
#  color header black white
#  color line-number black white
#  color id black white
#  color date black white
#  color author black white
#  color mode black white
#  color overflow black white
#  color directory black white
#  color file black white
#  color file-size black white

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

# *** MOUSE

# set mouse = yes
# set mouse-scroll = 1
# set mouse-wheel-cursor = yes

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

# *** BIND(INGS)

# CXREF: See also `man tigmanual`, in addition to `man tig` and `man tigrc`.

# TRYME: Test binding:
#
#   bind generic <C-x> +sh -c "echo You got me!"

# ***

# Default 'main' 'C' binding prompts ('?') and runs cherry-pick:
#   C ?git cherry-pick %(commit)
# But, like, why? I rarely cherry-pick, and I think it's always been
# revisions not reachable from HEAD. So I wouldn't care about the 'C'
# binding unless I was running tig on a disparate lineage. But I also
# do this operation so rarely, I'd probably want to run it more manually.
# - All that said, no shame in masking built-in 'main' 'C' cherry-pick
#   command. (Note that nothing built-in at 'C' for 'diff'.)
# - Note the default commit bindings only apply to main and diff,
#   so a mostly-truthful re-mapping is simply these two lines:
#     bind main C !sh -c "git commit -v"
#     bind diff C !sh -c "git commit -v"
#   But note (at least) one peculiar use case: I was in 'diff' view
#   and mashed 'u' until all chunks were staged. This left the 'diff'
#   view blank, so I hit 'C' think I could commit. Alas, "Unknown key".
#   So just bind to generic. Then user won't be aghast when binding
#   doesn't work. Also keeps our code DRY (because we don't have to
#   specify the same command for multiple keymaps (main, diff, etc.)).

bind generic C >sh -c " \
  git_commit_verbose________________________ () { \
    echo; \
    git commit -v; \
    echo; \
  }; git_commit_verbose________________________"

# The 'generic' binding does not shadow the same key bound
# to specific keymaps, so we must needs repeat ourself.
bind main C >sh -c " \
  git_commit_verbose________________________ () { \
    echo; \
    git commit -v; \
    echo; \
  }; git_commit_verbose________________________"

# ***

# 2020-12-16 18:56: Show commit date as elapsed time before now.
#
# - display (mixed) [relative|relative-compact|custom|default|<bool>]
#
#      If set to "relative" or "relative-compact" a relative date will be used,
#      e.g. "2 minutes ago" or "2m".
#
# - E.g's., 'default':
#
#             6848284 2020-12-16 usernom      o message foo
#             2dc2ab9 2020-12-15 usernom      o message bar
#             5033f9e 2020-12-14 usernom      o message baz
#
#           'relative':
#
#             6848284 20 minutes ago usernom      o message foo
#             2dc2ab9   27 hours ago usernom      o message bar
#             5033f9e     2 days ago usernom      o message baz
#
#           'relative-compact':
#
#             6848284 20M usernom      o message foo
#             2dc2ab9 27h usernom      o message bar
#             5033f9e 2d  usernom      o message baz
#
#   I think I like 'relative' because at a glance you can tell what's
#   recent (more letters) and what's older (fewer letters), just because
#   of how len('minutes') > len('hours') > len('days).
#
#   Or, perhaps a compromise solution that's more compact than
#   'relative', but where "20M" is more easily distinguisable
#   from "27h":
#
#           'relative' w/ width 6:
#
#             6848284 27 min usernom      o message foo
#             2dc2ab9 27 hou usernom      o message bar
#             5033f9e 2 days usernom      o message baz
#
# - tig's built-in 'D' cycles the date format, but not the column width.
#   - You can press ':' and enter the `set` command directly.
#   - Or you can use the bindings we've specified below.
set main-view-date-display = relative
set main-view-date-width = 6

# Mnemonic: 'T' for dateTime display.
# - Make date column wider, and change to datetime format.
bind generic T :set main-view-date = width:16,display:default

# Mnemonic: 'R' for relative date.
# - Make date column narrower, and change to relative format.
# - Note that 'R' by default also mapped to reload, but so is F5:
#           'R, <F5> refresh             Reload and refresh view'
bind generic R :set main-view-date = width:6,display:relative

# ***

# 2021-01-27: From `man tigrc` examples, might be useful if working on this file:
#
#   # "User-defined internal command that reloads ~/.tigrc"
#   bind generic S :source ~/.tigrc
#
# NOTE/2021-01-27: 'S' is already mapped, though it's not mentioned in the docs.
# - Run tig and press 'h' to see it's bound, but same as 's': `s, S view-status`.
#   So you could remap 'S' and not lose any functionality.

# ***

# Press `v` to open files in GVim.
#
# In diff view, the file that's under the cursor will be opened,
# and the cursor will be placed on the corresponding line.
#
# - Note: This works in a tig diff view.
#         But it does not work in a
#           `git diff a..b | tig` view.
#
# - I did not add a similar command to open the file in Vim
#   in the same terminal as tig, but you could do so with a
#   `!sh` so tig shows output, e.g.,
#
#       bind generic V !sh -c " \
#         vim -c \"call cursor(%(lineno), 0)\" \"%(directory)$(echo '%(file)' | sed 's/^b//')\""
#
# - CAVEAT: tig does not clear %(file) or %(lineno) if user quits 'diff'
#   view or otherwise moves cursor away from file diff.
#   - Fortunately, tig set %(lineno_old) to 0 when in such a state.
#     Use that to know if there's a file to open or not.
#   - Note also: file_old/lineno_old is the a/path file (the diff lhs).
#     (If you thought file_old/lineno_old was user's previous selection
#      in tig, then you're not alone; or maybe I'm the odd one.)
#     - I wonder if I should open a ticket and MR to also reset %(lineno) to
#       0 when %(lineno_old) is reset to 0, or if there's a reason it's not.
#
# - Mnemonic: Think 'v', as in Vim.
#
#   - Note this hides the default tig 'v', which
#     is show-version, e.g., 'tig-2.5.1'
#     - To access: :show-version.
#     - We'll also replace at 'V', why not.
#
# - This calls gvim-open-kindness (from Home Fries) to ensure that
#   file does not open in quickfix window, or the project tray, or
#   a help window, etc.
#     https://github.com/landonb/home-fries/blob/release/bin/gvim-open-kindness
#
# - I like to postfix project URLs with a pound '#' followed by an emoji.
#   But cannot use '#' in a tig config shell command string, or tig breaks.
#   One could substitute '?', which can be pasted to browser location, e.g.,
#   /gvim-open-kindness?üê¨. Another option is resolving \\x23 using bash -c.
bind generic v +sh -c " \
  open_line_under_cursor__gVim______________ () { \
    if [ -n \"%(file)\" ] && [ %(lineno_old) -ne 0 ]; then \
      if command -v gvim-open-kindness > /dev/null; then \
        gvim-open-kindness \"\" \"%(lineno)\" \"0\" \"%(directory)$(echo '%(file)' | sed 's/^b//')\"; \
      else \
        local gvok_url=\"https://github.com/DepoXy/gvim-open-kindness\\x23üê¨\"; \
        gvim --remote-silent \"%(directory)$(echo \"%(file)\" | sed \"s/^b//\")\"; \
        gvim --remote-send \"<ESC>:call cursor(\"%(lineno)\", \"0\")<CR>\"; \
        /bin/bash -c \"echo -e 'Improve ‚Äòv‚Äô with gvim-open-kindness: ${gvok_url}'\"; \
      fi; \
    else \
      echo \"Nothing to edit\"; \
    fi; \
  }; open_line_under_cursor__gVim______________"

bind generic V :show-version

# ***

# Here's how you might diagnose issues with open/edit commands:
#
#   bind generic V !sh -c " \
#     print_file_line_info () { \
#       >&2 echo \"file=%(file)\"; \
#       >&2 echo \"file_old=%(file_old)\"; \
#       >&2 echo \"lineno=%(lineno)\"; \
#       >&2 echo \"lineno_old=%(lineno_old)\"; \
#       >&2 echo \"directory=%(directory)\"; \
#     }; print_file_line_info"

# ***

# The diff-options option above breaks tig's built-in 'e' and :edit
# commands. Specifically, this setting above:
#
#   set diff-options = --src-prefix=a/ --dst-prefix=b/
#
# You can test against vanilla tig thusly (though still loads your Git config):
#
#   XDG_CONFIG_HOME=foo tig
#
# and you should see that 'e' works, and that the tig 'diff' view
# shows the `--- file` and `+++ file` without an a/ and b/ prefix
# (as opposed to how we format it, `--- a/file` and `+++ b/file`,
#  which makes it so tig-blame works (because tig-blame fails if
#  the paths *do not* have the a/ and b/ prefix, I know, right)).
#
# I have not searched GitHub Issues, but I would be surprised if
# this is an issue for the broader public, because it seems like
# something that would've been fixed (which is why I have not
# bothered to search GitHub Issues). So I assume it's something
# with my tig or Git configs, or development environment -- though
# not to say tig shouldn't be fixed, because this is ultimately a
# tig issue.
#
# Here we replace broken 'e' with a mostly faithful reproduction.
# Because we use '!' (full i/o, b/c Vim is interactive), even
# when there's nothing to edit, tig shells out and the user must
# 'Press Enter to continue'. This is different from the built-in 'e'
# command, where tig prints "Nothing to edit" to the status line, and
# tig never shells out and the user is not prompted.
# - BROKE: Note that the :edit command remains broken. Whatever, just
#   use 'e'. Or better yet, use 'v'.
# - SYNCD: See EDITOR resolution in tig/src/display.c open_editor():
#            Prefers TIG_EDITOR ‚Üí GIT_EDITOR ‚Üí VISUAL ‚Üí EDITOR ‚Üí vi.
bind generic e >sh -c " \
  open_line_under_cursor__editor____________ () { \
    if [ -n \"%(file)\" ] && [ %(lineno_old) -ne 0 ]; then \
      echo; \
      local editor=\"${TIG_EDITOR:-${GIT_EDITOR:-${VISUAL:-${EDITOR:-vi}}}}\"; \
      ${editor} +%(lineno) \"%(directory)$(echo \"%(file)\" | sed \"s/^b//\")\"; \
      echo; \
    else \
      echo \"Nothing to edit\"; \
    fi; \
  }; open_line_under_cursor__editor____________"

# ***

# 2020-12-14 15:04: Press 'x' to copy the commid ID/SHA1 hash.
#
# - From `man tigrc`:
#
#     Example 1. Configure a binding to copy the current commit ID to the clipboard.
#     bind generic I @sh -c "echo -n %(commit) | xclip -selection c"
#
#   - I'm guessing the 'I' chosen in the example stands for commit [I]D.
#
#   - I also like 'x', which is unbound, because 'X' is the commit ID toggle.
#
#   - Both c's are taken: 'c' is switch to stage view, and 'C' is cherry-pick
#     in main, and commit in status. Which is fine, I like 'x'.
#
# - How this works: Try xclip first (Linux), then fallback pbcopy (macOS).
#
# - Note that `xclip -selection c` is `xclip -selection clipboard` (XA_CLIPBOARD),
#   i.e., not the "primary" (XA_PRIMARY) X selection (which is the default).
#
# - Note also that tig ignores (doesn't show the user) any command output.
#
#   E.g., I had only `2> /dev/null` here first (i.e., not redirecting stdout)
#   but tig was nonetheless not showing any stdout when `type xclip` printed
#   "xclip is /usr/bin/xclip". Just an FYI, for whatever reason.
#
bind generic x @sh -c " \
  clipboard_copy__selected_commit_sha_______ () { \
    type xclip > /dev/null 2>&1 && \
      ( printf %(commit) | xclip -selection c ) \
      || ( printf %(commit) | pbcopy ); \
  }; clipboard_copy__selected_commit_sha_______"

# 2020-12-14 15:05: Show commit ID by default.
set main-view-id = yes

# ***

# Copy filepath to clipboard
# - Mnemonic: Copy 'P'ath
# - Note: This strips leading "b/" that tig prints, e.g., "a/path" and "b/path"
# - Note: This strips realpath newline using tr, but here's alt: | sed -z 's/\\n$//g'
bind generic P @sh -c " \
  clipboard_copy__file_path_________________ () { \
    local path=\"$(realpath -- \"%(directory)$(printf '%(file)' | sed 's/^b//')\" | tr -d '\\n')\"; \
    type xclip > /dev/null 2>&1 \
      && printf $path | xclip -selection c \
      || printf $path | pbcopy; \
  }; clipboard_copy__file_path_________________"

# ***

# Git-pwip binding.
# - <C-w> available, but I feel it's overloaded (kill word, close window, etc.).
#   <C-i> available, meh.
#   <C-t> could work, as in *Tidy*.
# - Note that I tried sync style, which lets us 'echo' message to status line:
#     bind generic <C-t> +sh -c "
#   Unfortunately the main display is not updated, and I don't know how to tell
#   tig to update the revision list. Fortunately, we can just use the '@sh'
#   binding, which blocks tig to run, and tig doesn't show its output, but
#   user at least sees revision list update to show new WIP commit. (See
#   also '!sh' option, but that hides tig window to show output in terminal
#   and prompts user to acknowledge.)
# - Note @sh better than >sh, so tig doesn't shell out for a blip.
bind generic <C-t> @sh -c " \
  wip_commit__push__aka_tidy_up_____________ () { \
    git_status_porcelain () { git status --porcelain=v1; }; \
    if [ -n \"$(git_status_porcelain)\" ]; then \
      git add -A \
        && git commit -q --no-verify -m 'PRIVATE: WIP'; \
    else \
      echo 'Already pristine'; \
    fi; \
  }; wip_commit__push__aka_tidy_up_____________"

# ***

# Git-pop binding.

# A very conversative git-pop binding:
# - Only pops the youngest commit.
# - Only pops a WIP commit.

# Note that running '+sh' synchronously, you can show status line upate,
# but after WIP removed, the tig view is not updated.
# - Fortunately running '@sh' in background, view updates immediately,
#   and no other user interaction happens, which is nice, because user
#   can see that the WIP commit was replaced with "Unstaged changes",
#   which is exactly my use case: pop the WIP commit, then stage and
#   commit it for reals [I seriously cannot think of a better term
#   than "for reals", seriously, what's the synonym I'm looking for?
#   "professionally"? "legitimately"? "deliberately"? for reals!].
# - Hrm, tig's built-in '^' command calls `:toggle rev-filter`, but a few
#   issues: "rev-filter" is not mentioned in the docs. `man tigmanual`
#   mentions "revision filtering" once:
#       ^   Toggle revision filtering in the main view.
#   But -- most importantly -- when I demo the toggle (it defaults so
#   revision filtering is on), I don't see a lick of change in the main
#   view. So, like, whatever, I'll mask this option if I want to, nothing
#   apparently lost.
#   - I originally used the unbound '_' binding:
#       bind generic _ @sh -c ...
#    but I'm gonna steal '^' because I like the mnemonic better --
#    pointing up, as in "popping off". (And I'm not going to remap
#    `:toggle rev-filter` because I don't use that setting/does nothing
#    for me.) (Also note this command changes revisions, and I like to
#    use a two-key press for changy commands, which this command
#    satisfies because it uses two keys: Shift and '6'.) (Also nice
#    about '^': it's above Ctrl-t (US American keyboard at least)
#    which is the wip-create command. So you can Ctrl-t/^/Ctrl-t/^/...
#    all day long.)
# - Note @sh better than >sh, so tig doesn't shell out for a blip.
bind generic ^ @sh -c " \
  wip_commit__pop___iff_youngest_rev________ () { \
    git_grep_youngest_rev () { \
      git --no-pager log --pretty=format:\"%H\" --grep \"$1\" HEAD^..HEAD; \
    }; \
    if [ -n \"$(git_grep_youngest_rev \"\\bWIP\\b\")\" ]; then \
      git reset --mixed @~1 > /dev/null; \
    else \
      echo 'Nothing WIPped'; \
    fi; \
  }; wip_commit__pop___iff_youngest_rev________"

# ***

# No-op shell-out to view output from previous command.
# - Hm, Escape works, but brief pause before you see shell:
#     bind generic <Esc> !sh -c "
# - Hm, responds "Only one view is displayed":
#     bind generic <C-i> !sh -c "
# - "Unknown key":
#     bind generic <C-.> !sh -c "
# Phew! Just period alone works, wasn't previously bound,
# and it's near Enter, which you hit to return to tig.
bind generic . !sh -c " \
  shell_out_to_view_previous_command_output_ () { \
    :; \
  }; shell_out_to_view_previous_command_output_"

# ***

# FIXME/2023-02-14 10:29: Use +sh and %(prompt)

# I like <C-x> except implies copied to clipboard and <C-z> undoable.
bind generic <C-o> >sh -c " \
  git_drop_revision_________________________ () { \
    echo; \
    printf \"Really drop %(commit)? [Y/n] \"; \
    read input; \
    if [ -z \"${input}\" ] || [ \"${input}\" = \"Y\" ] || [ \"${input}\" = \"y\" ]; then \
      echo \"git rebase --onto %(commit)^ %(commit)\"; \
      git rebase --onto %(commit)^ %(commit); \
    else \
      echo \"Ope\"; \
    fi; \
    echo; \
  }; git_drop_revision_________________________"

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

