#!/usr/bin/env bash
# vim:tw=0:ts=2:sw=2:et:norl:ft=bash
# Author: Landon Bouma (landonb &#x40; retrosoft &#x2E; com)
# Project: https://github.com/depoxy/tig-newtons#ðŸŽ
# License: MIT. Please find more in the LICENSE file.

# COPYD: This file is a pared-down copy of same-named file from:
#          https://github.com/landonb/git-smart#ðŸ’¡
#
# SYNC_ME: If you're using DepoXy
#            https://github.com/depoxy/depoxy#ðŸ¯
#          You can sync thusly:
#            meld \
#              ~/.kit/git/tig-newtons/bin/git-rebase-bubble-commit \
#              ~/.kit/git/git-smart/bin/git-rebase-bubble-commit &

# ***

git_rebase_buble_commit_noninteractive () {
  local ci_before="$1"
  local use_penultimate=${2:-false}

  local seditor="git-rebase-bubble-oldest"
  if ${use_penultimate}; then
    seditor="git-rebase-bubble-oldest-penultimate"
  fi

  local tnewtons_bin="$(dirname "$0")"
  seditor="${tnewtons_bin}/${seditor}"

  if [ ! -e "${seditor}" ]; then
    # DEV: This should be a tig-newtons error, because caller (command from
    #      tig config) verifies this file exists, so `dirname $0` is expected
    #      to be correct.
    >&2 echo
    >&2 echo "ERROR: Rebase stream editor missing or not executable: ${seditor}"

    exit 1
  fi

  GIT_SEQUENCE_EDITOR="${seditor}" \
    git rebase -i ${ci_before}
}

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ #

main () {
  git_rebase_buble_commit_noninteractive "$@"
}

if [ -z "${BASH_SOURCE}" ] || [ "$0" != "${BASH_SOURCE[0]}" ]; then
  >&2 echo "ERROR: Run this script with bash"

  exit 1
else
  main "$@"
fi

